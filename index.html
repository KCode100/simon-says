<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/main.css">
    <title>Simon Says</title>
</head>
<body>

    <main class="section-main">
        <header class="header">
            <i class="mute fas fa-volume-mute fa-volume-up"></i>
            <h2 class="header__command"></h2>
        </header>

        <div class="game-container row">
            <div class="btn btn--game btn--1" id="1"></div>
            <div class="btn btn--game btn--2" id="2"></div>
            <div class="btn btn--game btn--3" id="3"></div>
            <div class="btn btn--game btn--4" id="4"></div>
            <button class="btn btn__main">Play</button>
            <button class="btn btn__main btn__main--game-over game-over">
                Game over!
                restart
            </button>
        </div>
        
        <section class="section-btns">
        <div class="score">Score: <span id = "score">0</span></div>
            <button class="btn btn--speed slow">slow</button>
            <button class="btn btn--speed normal">normal</button>
            <button class="btn btn--speed fast">fast</button>
        </section>

        <audio class="sound" src="./mp3/simonsound1.mp3" type = "audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <audio class="sound" src="./mp3/simonsound2.mp3" type = "audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <audio class="sound" src="./mp3/simonsound3.mp3" type = "audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <audio class="sound" src="./mp3/simonsound4.mp3" type = "audio/mpeg">
            Your browser does not support the audio element.
        </audio>

    </main>
    

    <script>
        const commandEl = document.querySelector('.header__command');
        // const btnsContainer = document.querySelector('.game-container');
        const btnsEl = document.querySelectorAll('.btn--game');
        const startEl = document.querySelector('.btn__main');
        const gameOverEl = document.querySelector('.game-over');
        const speedBtnsEl = document.querySelectorAll('.btn--speed');
        const slowEl = document.querySelector('.slow');
        const normalEl = document.querySelector('.normal');
        const fastEl = document.querySelector('.fast');
        const soundEl = document.querySelector('.mute');
        const scoreEl = document.getElementById('score');
        const sounds = document.querySelectorAll('.sound');
        const slow = 1000;
        const normal = 700;
        const fast = 400;
        
        let userTurn = false;
        let comp = [];
        let user = [];
        let chosenSpeed = normal;
        let score = 0;
        let sound = 'on';
        
        // listen to btns and flash
        btnsEl.forEach(btn => btn.addEventListener('click', (e) => {
            if (userTurn) {
                const curr = e.target;
                curr.style.filter = "brightness(2)";
                setTimeout(()=>{
                    curr.style.filter = "brightness(1)";
                }, 300);
            }
        }));
        
        //  TOGGLE SOUND
        function toggleSound(e) {
            soundEl.classList.toggle("fa-volume-up");
            if (sound === 'on') {
                document.querySelectorAll('audio').forEach(el => {
                    el.muted = true;
                    sound = 'off';
                });
            } else if (sound === 'off') {
                document.querySelectorAll('audio').forEach(el => {
                    el.muted = false;
                    sound = 'on';
                });
            }
        }        

        // INITIATE COMPUTERS PATTERN
        function getRandom() {
            const random = btnsEl [ Math.floor (Math.random () * btnsEl.length)];
            comp.push (random);
        }

        // FLASH CURRENT ITEM
        function flash(item, index) {
            item.style.filter = "brightness(2)";
            setTimeout(()=>{
                item.style.filter = "brightness(1)";
            }, 250);

            // PLAY CORRESPONDING SOUND
            const currentElement = parseInt(item.id) - 1;
            sounds[currentElement].play();

            // UPDATE COMMAND WHEN SET IS OVER
            if (index === comp.length - 1) {
                setTimeout(()=> {
                    updateCommand('play');
                }, 800);
            }
        }
        
        // ADD GAP BETWEEN FLASHES
        function pause(item, index) {
            gap = index * chosenSpeed;
            setTimeout(() => {
                flash(item, index)
            }, gap);
            
        }

        // SHOW COMMAND
        function updateCommand(command) {
            commandEl.innerHTML = `${command}!`;
        }

        // LOOP THROUGH COMPUTERS PATTERN
        function displayOrder() {
            for (i = 0; i < comp.length; i++) {
                pause(comp[i], i);
            }
            
            userTurn = true;
            }

            // STILL IN THE GAME
            function continueGame() {
            removeStartBtn();
            user = [];
            getRandom();
            updateCommand('watch');
            setTimeout(()=> {
                displayOrder();
            }, 1000);
        }
        
        // RESET PATTERNS
        function resetPatterns() {
            comp = [];
            user = [];
        }

        // RESET CURRENT SCORE
        function resetScore() {
            scoreEl.innerHTML = 0;
        }

        // SHOW START BTN
        function showStartBtn() {
            startEl.style.display = 'inline-block';
        }

        // HIDE START BTN
        function removeStartBtn() {
            startEl.style.display = 'none';
        }

        // GAME OVER
        function gameOver() {
            userTurn = false;
            gameOverEl.style.display = 'inline-block';
        }

        // HIDE GAME OVER EL
        function hideGameOver() {
            gameOverEl.style.display = 'none';
        }

        // HARD RESET
        function newGame() {
            hideGameOver();
            showStartBtn();
            resetPatterns();
            resetScore();
            userTurn = false;
        }

        // SHOW CURRENT SCORE
        function updateScoreBoard() {
            scoreEl.innerHTML = score;
        }
        
        // CHOSEN SPEED
        window.addEventListener('click', function(e){
            if(e.target === fastEl) {
                chosenSpeed = fast;
            } else if (e.target === normalEl) {
                chosenSpeed = normal;
            } else if (e.target === slowEl) {
                chosenSpeed = slow;
            }

        // USERS INPUT
            if (userTurn && e.target.classList.contains('btn')) {

                // SAVE INPUT
                user.push(e.target);
                const length = user.length;
                const currRound = length - 1;

                // PLAY CORRESPONDING SOUND
                const currentElement = parseInt(e.target.id) - 1;
                sounds[currentElement].play();
                
                // IF USER'S CORRECT
                if (user[currRound] === comp[currRound]) {
                    // ADD SCORE
                    score ++;
                    updateScoreBoard();

                    // IF COMPLETED SET
                    if (user.length === comp.length) {
                        userTurn = false;
                        setTimeout(()=>{
                            continueGame();
                        }, 200);
                    }

                // IF USER'S INCORRECT
                } else {
                    gameOver();
                }
            }
        });

        // EVENT LISTENERS
        speedBtnsEl.forEach(btn => btn.addEventListener('click', newGame));
        startEl.addEventListener('click', continueGame);
        soundEl.addEventListener('click', toggleSound);
        gameOverEl.addEventListener('click', continueGame);

        // FUTURE ADDITIONS
        // => LEADER BOARD TABLE - NAME & SCORE
        // => LOCAL STORAGE / BACK END DATABASE
        // => KEYBOARD ARROWS TO SELECT BTNS
    </script>
</body>
</html>